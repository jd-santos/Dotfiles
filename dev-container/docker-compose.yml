# =============================================================================
# Three-Container Development Environment
# =============================================================================
# This configuration runs three container types with different trust levels:
#
#   dev-full        (port 2222) - Full personal development, account SSH key
#   openclaw-agent  (port 2223) - AI agent via messaging, deploy key
#   opencode-web    (port 2224) - Web-based AI assistant, deploy key
#
# Usage:
#   docker compose up -d                    # Start all containers
#   docker compose up -d dev-full           # Start just dev-full
#   docker compose logs -f                  # Watch all logs
#   docker compose down                     # Stop all containers
#
# First-time setup:
#   1. Create ~/.env with your API keys (see .env.example)
#   2. Ensure ~/.ssh/dev_container.pub exists for SSH access into containers
#   3. Run: docker compose up -d
#   4. Watch logs for SSH key instructions to add to GitHub
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # dev-full: Full Development Access
  # ---------------------------------------------------------------------------
  # Personal development container with account-level GitHub access.
  # Can push to any repo, any branch (including main).
  # Use this for hands-on development work.
  
  dev-full:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: dev-full
    hostname: dev-full
    
    environment:
      - CONTAINER_TYPE=dev-full
      - TZ=America/New_York
      - SHELL=/bin/zsh
    
    ports:
      - "2222:22"  # SSH access
    
    volumes:
      # Named volumes for persistence
      - dev-full-home:/home/dev
      - dev-full-ssh:/home/dev/.ssh
      
      # Bind mount for API keys (read-only)
      - ~/.env:/home/dev/.env:ro
      
      # Bind mount host public key for SSH access into container
      - ~/.ssh/dev_container.pub:/home/dev/.ssh/authorized_keys.d/host.pub:ro
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G
    
    networks:
      - dev-network

  # ---------------------------------------------------------------------------
  # openclaw-agent: CLI AI Agent (Restricted)
  # ---------------------------------------------------------------------------
  # AI coding agent that operates via messaging apps (WhatsApp, Telegram, etc.)
  # Can only access Dotfiles repo, cannot push to main branch.
  # Deploy key provides limited repository access.
  
  openclaw-agent:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: openclaw-agent
    hostname: openclaw-agent
    
    environment:
      - CONTAINER_TYPE=openclaw-agent
      - TZ=America/New_York
      - SHELL=/bin/zsh
    
    ports:
      - "2223:22"  # SSH access on different port
    
    volumes:
      # Named volumes for persistence (separate from dev-full)
      - openclaw-home:/home/dev
      - openclaw-ssh:/home/dev/.ssh
      
      # Bind mount for API keys (read-only)
      - ~/.env:/home/dev/.env:ro
      
      # Bind mount host public key for SSH access into container
      - ~/.ssh/dev_container.pub:/home/dev/.ssh/authorized_keys.d/host.pub:ro
      
      # Mount Cedar policies (read-only, for future Leash integration)
      - ./policies:/home/dev/policies:ro
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    
    networks:
      - dev-network

  # ---------------------------------------------------------------------------
  # opencode-web: Web-based AI Agent (Restricted)
  # ---------------------------------------------------------------------------
  # Browser-based AI coding assistant.
  # Similar restrictions to openclaw-agent.
  # Deploy key provides limited repository access.
  
  opencode-web:
    build:
      context: .
      dockerfile: Dockerfile
    
    container_name: opencode-web
    hostname: opencode-web
    
    environment:
      - CONTAINER_TYPE=opencode-web
      - TZ=America/New_York
      - SHELL=/bin/zsh
      # Optional: Set password for web interface security
      # - OPENCODE_SERVER_PASSWORD=your-secure-password
      # - OPENCODE_SERVER_USERNAME=opencode
    
    ports:
      - "2224:22"   # SSH access
      - "4096:4096" # OpenCode web UI
    
    volumes:
      # Named volumes for persistence (separate from others)
      - opencode-web-home:/home/dev
      - opencode-web-ssh:/home/dev/.ssh
      
      # Bind mount for API keys (read-only)
      - ~/.env:/home/dev/.env:ro
      
      # Bind mount host public key for SSH access into container
      - ~/.ssh/dev_container.pub:/home/dev/.ssh/authorized_keys.d/host.pub:ro
      
      # Mount Cedar policies (read-only, for future Leash integration)
      - ./policies:/home/dev/policies:ro
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    
    networks:
      - dev-network

# =============================================================================
# Named Volumes
# =============================================================================
# Each container has its own home and SSH volumes to ensure isolation.
# This prevents:
#   - Agent containers from accessing dev-full's account SSH key
#   - Cross-container data leakage
#   - Accidental overwrites of container-specific settings
#
# Backup command:
#   docker run --rm -v dev-full-home:/data -v $(pwd):/backup \
#     alpine tar czf /backup/dev-full-backup.tar.gz /data
#
# Restore command:
#   docker run --rm -v dev-full-home:/data -v $(pwd):/backup \
#     alpine tar xzf /backup/dev-full-backup.tar.gz -C /

volumes:
  # dev-full container
  dev-full-home:
    driver: local
  dev-full-ssh:
    driver: local
  
  # openclaw-agent container
  openclaw-home:
    driver: local
  openclaw-ssh:
    driver: local
  
  # opencode-web container
  opencode-web-home:
    driver: local
  opencode-web-ssh:
    driver: local

# =============================================================================
# Networks
# =============================================================================
# Containers share a network for potential inter-container communication
# but are isolated from the host network.

networks:
  dev-network:
    driver: bridge
