# Enable 256-color and true-color (24 bit)
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc" # Override to enable true-color

# Color Palette - Dracula Theme
bg='#282a36'           # Background
fg='#f8f8f2'           # Foreground
light='#f8f8f2'        # Light text
neutral='#44475a'      # Neutral / Selection
muted='#6272a4'        # Muted / Comment
purple='#bd93f9'       # Accent
cyan='#8be9fd'         # Info
green='#50fa7b'        # Success
yellow='#f1fa8c'       # Warning
red='#ff5555'          # Error
pink='#ff79c6'         # Zoom indicator


# Set prefix to backtick (`) - easy to reach and rarely used
# Press backtick to activate tmux command mode
set -g prefix `
unbind C-b

# Allow sending the prefix key through to nested sessions or applications
# Double-pressing the prefix sends the actual key combination to the active pane
# Useful for: nested tmux sessions, or apps that also use the same key binding
bind ` send-prefix

# ===== NESTED TMUX SESSION SUPPORT =====
# Scenario: SSH into remote machine that also runs tmux
# Problem: Prefix key (`) conflicts between local and remote sessions
#
# USAGE:
#   1. Default: All commands go to LOCAL session
#   2. Press F12: Toggle to NESTED mode - all commands go to REMOTE session
#      - Status bar turns RED and shows [NESTED]
#   3. Press F12 again: Toggle back to local mode
#
# WINDOW SWITCHING IN NESTED SESSIONS:
#   - Alt+1-9: Always switches windows in LOCAL session
#   - Alt+Shift+1-9: Always switches windows in REMOTE/NESTED session
#
# OTHER SHORTCUTS: Use Alt+key shortcuts (defined below) for common operations

# Nested session toggle - F12 to switch between local and remote session control
# When toggled to remote (F12), all keybindings go to the nested session
# Visual indicator in status bar shows current mode
bind F12 if-shell "[ $(tmux show-environment -g | grep -c NESTED_TMUX) -eq 0 ]" \
  "set -g NESTED_TMUX true; set -g status-style 'fg=$light,bg=$red'; display 'Nested mode ON - commands go to remote session'" \
  "set -u NESTED_TMUX; set -g status-style 'fg=$light,bg=$neutral'; display 'Nested mode OFF - commands go to local session'"

# When in nested mode, prefix sends through to remote session
bind -T root F12 if-shell "tmux show-environment -g | grep -q NESTED_TMUX" \
  "send-prefix" \
  "send-keys F12"

# Enable mouse support
set -g mouse on

# Use system clipboard
set -g set-clipboard on

# QOL improvements
set -g pane-base-index 1        # Match window base-index
set -g renumber-windows on      # No gaps when closing windows
set -sg escape-time 10          # Faster key response (helps vim)
set -g history-limit 10000      # More scrollback
set -g focus-events on          # Better neovim integration
set -g display-panes-time 3000  # Show pane numbers for 3 seconds
set -g status-interval 5        # Refresh status bar every 5 seconds

# Status bar styling
set -g status-position top
set -g status-left-length 100
set -g status-right-length 100
set -g status-style "fg=$light,bg=$neutral"
set -g status-left "#{?window_zoomed_flag,#[fg=${pink},bold]  ZOOM #[fg=${light},nobold](\`+z to exit) #[fg=${muted}]| ,}#[fg=${purple},bold]   #S #[fg=$light,nobold]#{?NESTED_TMUX, #[fg=${red},bold][NESTED]#[fg=$light], } | "
set -g status-right "#[fg=${cyan}]   #(cd #{pane_current_path} && git branch --show-current 2>/dev/null || echo 'no branch') #[fg=${muted}]| #[fg=${yellow}] 󰃭 %b %d "
set -g window-status-current-format "#[fg=${green},bold]   #[underscore]#I:#W"
set -g window-status-format " #I:#W"

# Window activity indicators
set -g monitor-activity on
set -g visual-activity off
set -g window-status-activity-style "fg=${yellow},bold"

# Border styling
set -g pane-border-style "fg=${neutral}"
set -g pane-active-border-style "fg=${purple}"

# Message styling
set -g message-style "fg=${muted}"

# Session styling
set -g mode-style "fg=${light}, bg=${muted}"

# Copy mode styling
set -g copy-mode-match-style "fg=${bg},bg=${yellow}"
set -g copy-mode-current-match-style "fg=${bg},bg=${green},bold"

# Vim-style copy mode
setw -g mode-keys vi
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Window indexing
set -g base-index 1

# Window switching with prefix + number (needed for nested sessions)
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

# Vim-like pane navigation with prefix + hjkl
# Press prefix (backtick) then h/j/k/l to move between panes
bind h select-pane -L  # Left
bind j select-pane -D  # Down
bind k select-pane -U  # Up
bind l select-pane -R  # Right

# Vim-like pane resizing with prefix + Shift + hjkl (repeatable)
bind -r H resize-pane -L 10
bind -r J resize-pane -D 10
bind -r K resize-pane -U 10
bind -r L resize-pane -R 10

# Quick window switching with Option+number (requires macos-option-as-alt = true in Ghostty)
# Option+number: Switch windows in LOCAL session
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Option+Shift+number: Switch windows in NESTED/REMOTE session
# (Shift+1 = !, Shift+2 = @, etc.)
bind -n M-! send-prefix \; send-keys 1
bind -n M-@ send-prefix \; send-keys 2
bind -n M-# send-prefix \; send-keys 3
bind -n M-$ send-prefix \; send-keys 4
bind -n M-% send-prefix \; send-keys 5
bind -n M-^ send-prefix \; send-keys 6
bind -n M-& send-prefix \; send-keys 7
bind -n M-* send-prefix \; send-keys 8
bind -n M-( send-prefix \; send-keys 9

# Essential nested-session-friendly keybindings (no prefix needed)
# These work in BOTH local and nested sessions without needing F12 toggle
#
# Option+z: Zoom/unzoom pane (very useful when working in nested sessions)
bind -n M-z resize-pane -Z

# Option+d: Detach from LOCAL session (useful even when in nested mode)
bind -n M-d detach-client

# Option+n: New window (accessible in nested sessions)
bind -n M-n new-window -c "#{pane_current_path}"

# Option+c: New window alternative (common tmux convention)
bind -n M-c new-window -c "#{pane_current_path}"

# Option+w: Show window list (for quick switching when many windows open)
bind -n M-w choose-window

# Option+[/]: Previous/next window (accessible in nested sessions)
bind -n M-[ previous-window
bind -n M-] next-window

# Split panes with | and - (more intuitive than " and %)
bind | split-window -h -c "#{pane_current_path}"  # Vertical split (side-by-side)
bind - split-window -v -c "#{pane_current_path}"  # Horizontal split (top-bottom)

# File Preview - Open fzf popup with bat preview
# Press Ctrl+f to open the popup
# Press Enter on a file to open it in vim in the underlying pane
bind C-f display-popup -w 80% -h 80% -E "fzf --preview 'bat --style=numbers --color=always --line-range :500 {}' --print0 | xargs -0 -I {} tmux send-keys -t '#{pane_id}' 'vim {}' Enter"

# Close pane
bind x kill-pane

# Reload configuration
unbind r
bind r source-file ~/.tmux.conf
